{"componentChunkName":"component---src-templates-post-js","path":"/blog/screenshot-testing-our-design-system-on-android/","result":{"data":{"ghostPost":{"id":"Ghost__Post__5ec2ca3d7aa22c4066f83b6c","title":"Screenshot Testing our Design System on Android","slug":"screenshot-testing-our-design-system-on-android","featured":false,"feature_image":"https://gojek-ghost.zysk.in/content/images/2020/05/1_CDWU7CE8XeZNDZ0fa4KNLw.jpeg","excerpt":"An overview of how we do screenshot tests, and the open source libraries that helped us along the way.","custom_excerpt":"An overview of how we do screenshot tests, and the open source libraries that helped us along the way.","visibility":"public","created_at_pretty":"18 May, 2020","published_at_pretty":"14 January, 2020","updated_at_pretty":"18 May, 2020","created_at":"2020-05-18T23:17:41.000+05:30","published_at":"2020-01-14T09:30:00.000+05:30","updated_at":"2020-05-18T23:43:30.000+05:30","meta_title":null,"meta_description":"An overview of how we do screenshot tests, and the open source libraries that helped us along the way.","og_description":null,"og_image":null,"og_title":null,"twitter_description":null,"twitter_image":null,"twitter_title":null,"authors":[{"name":"Gojek","slug":"gojek","bio":null,"profile_image":null,"twitter":"@gojektech","facebook":null,"website":"http://www.gojek.io"}],"primary_author":{"name":"Gojek","slug":"gojek","bio":null,"profile_image":null,"twitter":"@gojektech","facebook":null,"website":"http://www.gojek.io"},"primary_tag":{"name":"Design","slug":"design","description":"Chronicles of the design journeys behind Gojek products, case studies, and insights on UI/UX design.","feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"},"tags":[{"name":"Design","slug":"design","description":"Chronicles of the design journeys behind Gojek products, case studies, and insights on UI/UX design.","feature_image":null,"meta_description":null,"meta_title":null,"visibility":"public"}],"plaintext":"By Jitin Sharma\n\nIn this post, weâ€™ll take a look at how we test our Design System components on\nAndroid using screenshot tests to make them pixel perfect. ðŸ‘Œ\n\nLetâ€™s start with an example.\n\nTake a look at these two images:\n\nAre these images identical?They may look the same, but they arenâ€™t! Hereâ€™s\nwhatâ€™s different:\n\nThere are two subtle changes â€” the colour of the button is a different shade of\ngreen and the elevation is also different.\n\nIn Asphalt\n[https://blog.gojekengineering.com/ux-engineering-at-gojek-9de2abe24928], our\ndesign language system, we want to make sure our UI components are robust and\ndetect breakages early. Hereâ€™s how we leveraged screenshot tests to achieve\nthis.\n\nComponents Everywhere\nAsphalt Components in Gojek appWith Asphalt, we create components that can be\nreused across the Gojek app. Every button, text, input, or card which you see in\nmost of the screens of the app is an Asphalt Component. On top of this, we have\na demo app which showcases the usage of these components.\n\nAsphalt Components in Demo appOur components are the backbone of the Gojek app\nUI. For example, our button class has 300+ occurrences across Gojekâ€™s consumer\napp codebase. This heavy reuse helps us enforce design guidelines across the\napp. The importance of these components requires that we test them thoroughly,\nas even a small regression in one component could mean a degraded experience for\nour users.\n\n[U]n[I]t Testing\nUnit tests are supposed to test logic and fail when expectations arenâ€™t met. How\ndo we expect that a certain UI is being rendered properly?\n\nThe idea of screenshot testing is to have a master copy of screenshots that we\nknow are correct and on every test run compare the current screenshots to the\nmaster copy. If the current set does not match the master set, the test fails.\nThis will allow us to check unintentional UI changes. If the changes are\nintentional, then we run the tests in update mode which updates the master\nscreenshots.\n\nHere is the high level outline:\n\n> - Write Espresso test for all activities in the demo\n> - Take screenshots and create a master set\n> - At every CI run take screenshots again and compare with master set\nWe started out with Shot [https://github.com/Karumi/Shot], an open source\nlibrary which allows us to take screenshots and compare them using gradle\ncommands and generate reports.\n\nHereâ€™s what a test for our Alert component looks like ðŸ‘‡\n\nAchilles Heel â€” The Android Emulator\nWhile the Android emulator has improved a lot in recent times, we found running\nemulators in CI is still unreliable.\n\nHere are a few issues we faced:\n\n> - We had to wait to for the emulator to start up, which was only possible\nthrough a hack(y) script by continuously pinging adb commands\n> Emulator would put more memory pressure on CI runners\n> Emulators also need hardware acceleration which required us to enable kvm on our\nLinux-based machines.\nRunning Instrumentation test cases with these issues would mean our tests would\nbe flaky â€” and we couldnâ€™t have that.\n\nFirebase Test Lab saves the day!\nWe decide to move away from emulators to real devices.\n\nOne idea was to have devices connected to a machine and use the machine as a\nrunner for running test cases in CI â€” a device test lab.\n\nBut devices come with their own baggage â€” maintaining them. They may be\ninterrupted by software updates, system dialogsâ€¦ or get overcharged and explode!\nðŸ”¥\n\nWe found the next best thing: Firebase Test Lab\n[https://firebase.google.com/docs/test-lab] â€” a set of devices in cloud, managed\nautomatically and available via CLI.\n\nThis solved our device problem, but we ran into another one â€” Firebase Test Lab\ndoesnâ€™t allow you to run custom gradle commands. Instead, it expects you to\nupload a debug and a test apk, and it will run the tests for you. This meant we\ncould no longer use Shot for taking screenshots and comparing them ðŸ˜¦\n\nWhile scratching our heads over how to overcome this problem, we found that\nFirebase Test Lab allows you\n[https://firebase.google.com/docs/test-lab/android/test-screenshots] to take\nscreenshots through a library and then retrieve them from Google Cloud Bucket.\n\nThere is also a gradle plugin [https://github.com/runningcode/fladle/] which\nautomates this process including downloading artifacts from GCP â€” open source to\nthe rescue again!\n\nHereâ€™s how our test case looks like with Firebase screenshot library:\n\nFor image comparison we used ImageMagick [https://imagemagick.org/], a very\npopular and feature-packed CLI tool for image manipulation. It also allows us to\noutput a different image in case two images donâ€™t match, which is super useful\nfor generating test failure reports.\n\nThe final piece â€” integrating screenshot tests into our developer workflow\nAs part of CI, we do the following things when a merge request is raised:\n\n> - Build the project\n> - Run Espresso Tests on Firebase Test Lab\n> - Retrieve screenshots and compare them with master set\n> - If any screenshot doesnâ€™t match, we fail the build and add a comment to PR\nusing Danger [https://danger.systems/]\nDanger reporting mismatch in screenshot along with diff image.We have been using\nthis setup for some time now, and itâ€™s worked out great for us! We have been\nable to execute multiple UI refactors with high confidence.\n\nWhatâ€™s next?\nWe will continue to invest in this setup in the future. Things like testing\nlocalisation, having a test matrix with multiple screen sizes, API levels,\ndevice densitiesâ€¦ these are some things we have planned for the future.\n\nA big thank you to the open source libraries that helped us achieve this!\n\n\n--------------------------------------------------------------------------------\n\nLiked what you read? Sign up for our newsletter\n[https://mailchi.mp/go-jek/gojek-tech-newsletter] and weâ€™ll send you weekly\nupdates about our stories! ðŸ––","html":"<p>By Jitin Sharma</p><p>In this post, weâ€™ll take a look at how we test our Design System components on Android using screenshot tests to make them pixel perfect. ðŸ‘Œ</p><p>Letâ€™s start with an example.</p><p>Take a look at these two images:</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"https://miro.medium.com/max/1052/1*GON1POsYNn-n13Yvx9KWlQ.png\" class=\"kg-image\"><figcaption>Are these images identical?</figcaption></figure><p>They may look the same, but they arenâ€™t! Hereâ€™s whatâ€™s different:</p><figure class=\"kg-card kg-image-card\"><img src=\"https://miro.medium.com/max/1052/1*0Cunmda2Ctain_g4xPU3iQ.png\" class=\"kg-image\"></figure><p>There are two subtle changes â€” the colour of the button is a different shade of green and the elevation is also different.</p><p>In <a href=\"https://blog.gojekengineering.com/ux-engineering-at-gojek-9de2abe24928\" rel=\"noopener\">Asphalt</a>, our design language system, we want to make sure our UI components are robust and detect breakages early. Hereâ€™s how we leveraged screenshot tests to achieve this.</p><h1 id=\"components-everywhere\">Components Everywhere</h1><figure class=\"kg-card kg-image-card kg-width-wide kg-card-hascaption\"><img src=\"https://miro.medium.com/max/1584/1*UH05mhuGHielEDM4RtbOcQ.png\" class=\"kg-image\"><figcaption>Asphalt Components in Gojek app</figcaption></figure><p>With Asphalt, we create components that can be reused across the Gojek app. Every button, text, input, or card which you see in most of the screens of the app is an Asphalt Component. On top of this, we have a demo app which showcases the usage of these components.</p><figure class=\"kg-card kg-image-card kg-width-wide kg-card-hascaption\"><img src=\"https://miro.medium.com/max/1220/1*ixxp__0PC20bAMigugixhg.png\" class=\"kg-image\"><figcaption>Asphalt Components in Demo app</figcaption></figure><p>Our components are the backbone of the Gojek app UI. For example, our button class has 300+ occurrences across Gojekâ€™s consumer app codebase. This heavy reuse helps us enforce design guidelines across the app. The importance of these components requires that we test them thoroughly, as even a small regression in one component could mean a degraded experience for our users.</p><h1 id=\"-u-n-i-t-testing\">[U]n[I]t Testing</h1><p>Unit tests are supposed to test logic and fail when expectations arenâ€™t met. How do we expect that a certain UI is being rendered properly?</p><p>The idea of screenshot testing is to have a master copy of screenshots that we know are correct and on every test run compare the current screenshots to the master copy. If the current set does not match the master set, the test fails. This will allow us to check unintentional UI changes. If the changes are intentional, then we run the tests in <code>update</code> mode which updates the master screenshots.</p><p><strong><strong>Here is the high level outline:</strong></strong></p><blockquote><em><em>- Write Espresso test for all activities in the demo</em></em></blockquote><blockquote><em><em>- Take screenshots and create a master set</em></em></blockquote><blockquote><em><em>- At every CI run take screenshots again and compare with master set</em></em></blockquote><p>We started out with <a href=\"https://github.com/Karumi/Shot\" rel=\"noopener\">Shot</a>, an open source library which allows us to take screenshots and compare them using gradle commands and generate reports.</p><p>Hereâ€™s what a test for our Alert component looks like ðŸ‘‡</p><!--kg-card-begin: html--><script src=\"https://gist.github.com/jitinsharma/c57e8afbb0b4849ff75a29eeba4dc4d1.js\"></script><!--kg-card-end: html--><h1 id=\"achilles-heel-the-android-emulator\">Achilles Heel â€” The Android Emulator</h1><figure class=\"kg-card kg-image-card\"><img src=\"https://miro.medium.com/max/1400/0*WWyaL1uLibHeXC15.png\" class=\"kg-image\"></figure><p>While the Android emulator has improved a lot in recent times, we found running emulators in CI is still unreliable.</p><p>Here are a few issues we faced:</p><blockquote><em><em>- We had to wait to for the emulator to start up, which was only possible through a hack(y) script by continuously pinging <code>adb</code> commands</em></em></blockquote><blockquote><em><em>Emulator would put more memory pressure on CI runners</em></em></blockquote><blockquote><em><em>Emulators also need hardware acceleration which required us to enable <code>kvm</code> on our Linux-based machines.</em></em></blockquote><p>Running Instrumentation test cases with these issues would mean our tests would be flaky â€” and we couldnâ€™t have that.</p><h1 id=\"firebase-test-lab-saves-the-day-\">Firebase Test Lab saves the day!</h1><figure class=\"kg-card kg-image-card\"><img src=\"https://miro.medium.com/max/1280/0*IIH6x5bWvHn1Gcv_.jpg\" class=\"kg-image\"></figure><p>We decide to move away from emulators to real devices.</p><p>One idea was to have devices connected to a machine and use the machine as a runner for running test cases in CI â€” a device test lab.</p><p>But devices come with their own baggage â€” maintaining them. They may be interrupted by software updates, system dialogsâ€¦ or get overcharged and explode! ðŸ”¥</p><p>We found the next best thing: <a href=\"https://firebase.google.com/docs/test-lab\" rel=\"noopener\">Firebase Test Lab</a> â€” a set of devices in cloud, managed automatically and available via CLI.</p><p>This solved our device problem, but we ran into another one â€” Firebase Test Lab doesnâ€™t allow you to run custom gradle commands. Instead, it expects you to upload a debug and a test apk, and it will run the tests for you. This meant we could no longer use Shot for taking screenshots and comparing them ðŸ˜¦</p><p>While scratching our heads over how to overcome this problem, we found that Firebase Test Lab <a href=\"https://firebase.google.com/docs/test-lab/android/test-screenshots\" rel=\"noopener\">allows you</a> to take screenshots through a library and then retrieve them from Google Cloud Bucket.</p><p>There is also a <a href=\"https://github.com/runningcode/fladle/\" rel=\"noopener\">gradle plugin</a> which automates this process including downloading artifacts from GCP â€” open source to the rescue again!</p><p>Hereâ€™s how our test case looks like with Firebase screenshot library:</p><!--kg-card-begin: html--><script src=\"https://gist.github.com/jitinsharma/971c95389af0ae11b38f392076dc6df8.js\"></script><!--kg-card-end: html--><p>For image comparison we used <a href=\"https://imagemagick.org/\" rel=\"noopener\">ImageMagick</a>, a very popular and feature-packed CLI tool for image manipulation. It also allows us to output a different image in case two images donâ€™t match, which is super useful for generating test failure reports.</p><h1 id=\"the-final-piece-integrating-screenshot-tests-into-our-developer-workflow\">The final piece â€” integrating screenshot tests into our developer workflow</h1><p>As part of CI, we do the following things when a merge request is raised:</p><blockquote><em><em>- Build the project</em></em></blockquote><blockquote><em><em>- Run Espresso Tests on Firebase Test Lab</em></em></blockquote><blockquote><em><em>- Retrieve screenshots and compare them with master set</em></em></blockquote><blockquote><em><em>- If any screenshot doesnâ€™t match, we fail the build and add a comment to PR using <a href=\"https://danger.systems/\" rel=\"noopener\">Danger</a></em></em></blockquote><figure class=\"kg-card kg-image-card kg-width-wide kg-card-hascaption\"><img src=\"https://miro.medium.com/max/1970/1*D6gb_yARAM4n83umso03Xw.png\" class=\"kg-image\"><figcaption>Danger reporting mismatch in screenshot along with diff image.</figcaption></figure><p>We have been using this setup for some time now, and itâ€™s worked out great for us! We have been able to execute multiple UI refactors with high confidence.</p><h1 id=\"what-s-next\">Whatâ€™s next?</h1><p>We will continue to invest in this setup in the future. Things like testing localisation, having a test matrix with multiple screen sizes, API levels, device densitiesâ€¦ these are some things we have planned for the future.</p><p>A big thank you to the open source libraries that helped us achieve this!</p><hr><p>Liked what you read? <a href=\"https://mailchi.mp/go-jek/gojek-tech-newsletter\" rel=\"noopener\">Sign up for our newsletter</a> and weâ€™ll send you weekly updates about our stories! ðŸ––</p>","url":"https://gojek-ghost.zysk.in/screenshot-testing-our-design-system-on-android/","canonical_url":null,"uuid":"4a57a774-789f-4e2c-ac66-c0896c460a22","page":null,"codeinjection_foot":null,"codeinjection_head":null,"codeinjection_styles":null,"comment_id":"5ec2ca3d7aa22c4066f83b6c","reading_time":5}},"pageContext":{"slug":"screenshot-testing-our-design-system-on-android"}}}